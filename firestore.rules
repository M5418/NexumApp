rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS FOR BOTH APPS
    // ============================================
    
    // Consumer App (NexumApp) - Regular users
    function isConsumerUser() {
      return request.auth != null && 
             (request.auth.token.firebase.tenant == null || 
              request.auth.token.firebase.tenant != 'nexumOffice-mxel5');
    }
    
    // Office App (NexumOffice) - Tenant-based staff
    function isOfficeTenant() {
      return request.auth != null &&
             request.auth.token.firebase.tenant == 'nexumOffice-mxel5';
    }
    
    function isOfficeUser() {
      return request.auth != null && (
        request.auth.token.admin == true ||
        request.auth.token.moderator == true ||
        request.auth.token.kyc_agent == true ||
        request.auth.token.employee == true
      );
    }
    
    function hasRole(role) {
      return isOfficeUser() && 
             request.auth.token[role] == true;
    }
    
    function isAdmin() {
      return hasRole('admin');
    }

    function isPeopleAdmin() {
      return isOfficeUser() && (
        request.auth.token.email == 'dehoua@nexum-connects.com' ||
        request.auth.token.email == 'dehouaguy4@gmail.com' ||
        request.auth.token.email == 'moussayeconstant@gmail.com'
      );
    }
    
    function isModerator() {
      return hasRole('moderator') || isAdmin();
    }
    
    function isKycAgent() {
      return hasRole('kyc_agent') || isAdmin();
    }
    
    // Consumer app helpers
    function signedIn() { 
      return request.auth != null; 
    }
    
    function isOwner(uid) { 
      return signedIn() && request.auth.uid == uid; 
    }
    
    // ============================================
    // OFFICE-ONLY COLLECTIONS
    // ============================================
    
    // Admin audit logs
    match /admin_actions/{document=**} {
      allow read: if isAdmin();
      allow write: if request.auth != null;
    }
    
    // Dashboard snapshots
    match /dashboard_snapshots/{snapshotId} {
      allow read: if isOfficeUser();
      allow write: if false;
    }
    
    // Office user profiles
    match /office_users/{uid} {
      allow read: if isOfficeUser() || (isOfficeTenant() && request.auth.uid == uid);
      allow write: if request.auth != null && request.auth.uid == uid;
    }

    // Office employees directory
    match /office_employees/{id} {
      allow read: if isOfficeUser();
      allow write: if isAdmin() || isPeopleAdmin();
    }
    
    // Office conversations
    match /office_conversations/{threadId} {
      allow read: if isOfficeUser();
      allow create: if isOfficeUser();
      allow update: if isOfficeUser();
      allow delete: if isAdmin();
      
      match /messages/{messageId} {
        allow read: if isOfficeUser();
        allow write: if isOfficeUser();
      }
    }
    
    // Office templates
    match /office_templates/{teamId}/templates/{templateId} {
      allow read: if isOfficeUser();
      allow write: if isAdmin() || request.auth.token.team == teamId;
    }
    
    // ============================================
    // SHARED COLLECTIONS (Both Apps)
    // ============================================
    
    // User profiles - Public read, owner writes, office reads
    match /users/{uid} {
      allow read: if true;
      allow create: if isOwner(uid);
      allow update: if isOwner(uid) || isAdmin();
      allow delete: if isOwner(uid) || isAdmin();
      
      match /notifications/{notifId} {
        allow read: if isOwner(uid);
        allow create: if signedIn();
        allow update: if isOwner(uid);
        allow delete: if isOwner(uid);
      }
    }
    
    // Posts - Public read, owner writes, office moderates
    match /posts/{postId} {
      allow read: if true;
      allow create: if signedIn() &&
        request.resource.data.authorId == request.auth.uid;
      allow update: if signedIn() && 
        (request.auth.uid == resource.data.authorId || isAdmin() || isModerator());
      allow delete: if signedIn() && 
        (request.auth.uid == resource.data.authorId || isAdmin() || isModerator());
      
      match /likes/{likeId} {
        allow read: if true;
        allow create: if signedIn() &&
          likeId == request.auth.uid &&
          request.resource.data.keys().hasOnly(['createdAt']);
        allow delete: if signedIn() && likeId == request.auth.uid;
      }
      
      match /bookmarks/{bookmarkId} {
        allow read: if signedIn();
        allow create: if signedIn() &&
          bookmarkId == request.auth.uid &&
          request.resource.data.keys().hasOnly(['createdAt']);
        allow delete: if signedIn() && bookmarkId == request.auth.uid;
      }
    }
    
    // Community Posts
    match /community_posts/{postId} {
      allow read: if true;
      allow create: if signedIn() &&
        request.resource.data.authorId == request.auth.uid &&
        request.resource.data.communityId != null;
      allow update: if signedIn() && 
        (request.auth.uid == resource.data.authorId || isAdmin() || isModerator());
      allow delete: if signedIn() && 
        (request.auth.uid == resource.data.authorId || isAdmin() || isModerator());
      
      match /likes/{likeId} {
        allow read: if true;
        allow create: if signedIn() &&
          likeId == request.auth.uid &&
          request.resource.data.keys().hasOnly(['createdAt']);
        allow delete: if signedIn() && likeId == request.auth.uid;
      }
      
      match /bookmarks/{bookmarkId} {
        allow read: if signedIn();
        allow create: if signedIn() &&
          bookmarkId == request.auth.uid &&
          request.resource.data.keys().hasOnly(['createdAt']);
        allow delete: if signedIn() && bookmarkId == request.auth.uid;
      }
    }
    
    // Comments - Public read, owner writes, office moderates
    match /comments/{commentId} {
      allow read: if true;
      allow create: if signedIn();
      allow update: if signedIn() && 
        (request.auth.uid == resource.data.authorId || isAdmin() || isModerator());
      allow delete: if signedIn() && 
        (request.auth.uid == resource.data.authorId || isAdmin() || isModerator());
      
      match /likes/{likeId} {
        allow read: if true;
        allow create: if signedIn();
        allow delete: if signedIn();
      }
    }
    
    // Follows
    match /follows/{id} {
      allow read: if true;
      allow create: if signedIn();
      allow delete: if signedIn();
      allow update: if signedIn();
    }
    
    // Invitations
    match /invitations/{invitationId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if signedIn();
    }
    
    // Conversations
    match /conversations/{conversationId} {
      allow read: if signedIn() || isOfficeUser();
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if signedIn();
      
      match /messages/{msgId} {
        allow read: if signedIn() || isOfficeUser();
        allow create: if signedIn();
        allow update: if signedIn();
        allow delete: if signedIn();
      }
    }
    
    // Communities
    match /communities/{communityId} {
      allow read: if true;
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if isAdmin();
      
      match /members/{memberId} {
        allow read: if true;
        allow create: if signedIn();
        allow update: if signedIn();
        allow delete: if signedIn();
      }
    }
    
    // CollectionGroup for members
    match /{path=**}/members/{memberId} {
      allow read: if true;
    }
    
    // CollectionGroup for likes
    match /{path=**}/likes/{likeId} {
      allow read: if signedIn();
      allow create: if signedIn() && likeId == request.auth.uid;
      allow delete: if signedIn() && likeId == request.auth.uid;
    }
    
    // CollectionGroup for bookmarks
    match /{path=**}/bookmarks/{bookmarkId} {
      allow read: if signedIn();
      allow create: if signedIn() && bookmarkId == request.auth.uid;
      allow delete: if signedIn() && bookmarkId == request.auth.uid;
    }
    
    // Stories
    match /stories/{storyId} {
      allow read: if true;
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if signedIn();

      match /replies/{replyId} {
        allow read: if true;
        allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if false;
        allow delete: if signedIn() && (request.auth.uid == resource.data.userId || isAdmin());
      }
    }
    
    // Story rings
    match /story_rings/{ringId} {
      allow read: if true;
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if signedIn();
    }
    
    // Books
    match /books/{bookId} {
      allow read: if true;
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if isAdmin();
    }
    
    // Book categories
    match /book_categories/{categoryId} {
      allow read: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Book progress
    match /book_progress/{progressId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if signedIn();
    }
    
    // Podcasts
    match /podcasts/{podcastId} {
      allow read: if true;
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if isAdmin();
    }
    
    // Podcast categories
    match /podcast_categories/{categoryId} {
      allow read: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Podcast progress
    match /podcast_progress/{progressId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if signedIn();
    }
    
    // Mentors
    match /mentors/{mentorId} {
      allow read: if true;
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if signedIn();
    }
    
    // Mentorship conversations
    match /mentorship_conversations/{conversationId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if signedIn();
    }
    
    // Mentorship fields
    match /mentorship_fields/{fieldId} {
      allow read: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Mentorship requests
    match /mentorship_requests/{requestId} {
      allow read: if signedIn() || isOfficeUser();
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if signedIn();
    }
    
    // Reports - Office moderates
    match /reports/{reportId} {
      allow read: if isAdmin() || isModerator();
      allow create: if signedIn();
      allow update: if isAdmin() || isModerator();
      allow delete: if isAdmin() || isModerator();
    }
    
    // KYC requests - Office processes
    match /kyc_requests/{kycId} {
      allow read: if signedIn() && (isOwner(resource.data.userId) || isAdmin() || isKycAgent());
      allow create: if signedIn();
      allow update: if isAdmin() || isKycAgent();
      allow delete: if isAdmin();
    }
    
    // Blocks
    match /blocks/{blockId} {
      allow read: if signedIn() && 
        (request.auth.uid == resource.data.blockedByUid || isAdmin());
      allow create: if signedIn() && request.auth.uid == request.resource.data.blockedByUid;
      allow delete: if signedIn() && 
        (request.auth.uid == resource.data.blockedByUid || isAdmin());
    }
    
    // Mutes
    match /mutes/{muteId} {
      allow read: if signedIn() && 
        (request.auth.uid == resource.data.mutedByUid || isAdmin());
      allow create: if signedIn() && request.auth.uid == request.resource.data.mutedByUid;
      allow delete: if signedIn() && 
        (request.auth.uid == resource.data.mutedByUid || isAdmin());
    }
    
    // Bookmarks (top-level)
    match /bookmarks/{bookmarkId} {
      allow read: if signedIn() && 
        (request.auth.uid == resource.data.userId || isAdmin());
      allow create: if signedIn() && 
        request.auth.uid == request.resource.data.userId &&
        request.resource.data.keys().hasAll(['userId', 'type', 'itemId', 'createdAt']) &&
        request.resource.data.type in ['post', 'podcast', 'book'];
      allow update: if false;
      allow delete: if signedIn() && 
        (request.auth.uid == resource.data.userId || isAdmin());
    }
    
    // Drafts
    match /drafts/{draftId} {
      allow read: if signedIn() && 
        (request.auth.uid == resource.data.userId || isAdmin());
      allow create: if signedIn() && 
        request.auth.uid == request.resource.data.userId &&
        request.resource.data.keys().hasAll(['userId', 'type', 'title', 'body', 'createdAt', 'updatedAt']) &&
        request.resource.data.type in ['post', 'podcast'];
      allow update: if signedIn() && 
        (request.auth.uid == resource.data.userId || isAdmin()) &&
        request.resource.data.userId == resource.data.userId;
      allow delete: if signedIn() && 
        (request.auth.uid == resource.data.userId || isAdmin());
    }
    
    // Support tickets
    match /support_tickets/{ticketId} {
      // Consumers can read their own tickets, all office users can read all tickets
      allow read: if signedIn() && 
        (request.auth.uid == resource.data.userId || isOfficeUser());
      
      // Consumers can create tickets
      allow create: if signedIn() && 
        request.auth.uid == request.resource.data.userId;
      
      // All office users can respond and update tickets (not just admins)
      allow update: if isOfficeUser();
      
      // Only admins can delete tickets (safer option)
      allow delete: if isAdmin();
    }
    
    // Podcast playlists
    match /podcast_playlists/{playlistId} {
      allow read: if signedIn() && request.auth.uid == resource.data.userId;
      allow create: if signedIn() && 
        request.auth.uid == request.resource.data.userId &&
        request.resource.data.keys().hasAll(['name', 'userId', 'isPrivate', 'podcastIds', 'createdAt', 'updatedAt']);
      allow update: if signedIn() && 
        request.auth.uid == resource.data.userId &&
        request.resource.data.userId == resource.data.userId;
      allow delete: if signedIn() && request.auth.uid == resource.data.userId;
    }
    
    // ============================================
    // MONETIZATION COLLECTIONS
    // ============================================
    
    // Monetization profiles
    match /monetization_profiles/{userId} {
      allow read: if signedIn() && (request.auth.uid == userId || isAdmin());
      allow create: if signedIn() && request.auth.uid == userId;
      allow update: if signedIn() && (request.auth.uid == userId || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Earnings
    match /earnings/{earningId} {
      allow read: if signedIn() && (request.auth.uid == resource.data.userId || isAdmin());
      // Allow anyone signed in to create earnings (for content owners when their content is viewed)
      allow create: if signedIn();
      allow update: if isAdmin(); // Only admins can update status
      allow delete: if isAdmin();
    }
    
    // Earnings summaries
    match /earnings_summaries/{userId} {
      allow read: if signedIn() && (request.auth.uid == userId || isAdmin());
      // Allow anyone signed in to create/update summaries (for aggregating content owner earnings)
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if isAdmin();
    }
    
    // Payouts
    match /payouts/{payoutId} {
      allow read: if signedIn() && (request.auth.uid == resource.data.userId || isAdmin());
      allow create: if signedIn() && request.auth.uid == request.resource.data.userId;
      allow update: if isAdmin(); // Only admins can update payout status
      allow delete: if isAdmin();
    }
    
    // Premium subscriptions
    match /premium_subscriptions/{subscriptionId} {
      allow read: if signedIn() && (request.auth.uid == resource.data.userId || isAdmin());
      allow create: if signedIn() && request.auth.uid == request.resource.data.userId;
      allow update: if signedIn() && (request.auth.uid == resource.data.userId || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Content monetization stats
    match /content_monetization_stats/{contentId} {
      // Allow read for any signed-in user (needed to check if doc exists before update)
      allow read: if signedIn();
      // Anyone signed in can create/update stats (for tracking views on any content)
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if isAdmin();
    }
    
    // Analytics tracking collection (for individual view/engagement events)
    match /content_analytics/{analyticsId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if isAdmin();
    }
    
    // Group Chats
    match /groups/{groupId} {
      // Members can read group info
      allow read: if signedIn() && request.auth.uid in resource.data.memberIds;
      
      // Any signed-in user can create a group
      allow create: if signedIn() && 
        request.auth.uid == request.resource.data.createdBy &&
        request.auth.uid in request.resource.data.memberIds &&
        request.auth.uid in request.resource.data.adminIds &&
        request.resource.data.memberIds.size() <= 200;
      
      // Members can update (repo handles permission checks)
      allow update: if signedIn() && request.auth.uid in resource.data.memberIds;
      
      // Only admins can delete
      allow delete: if signedIn() && request.auth.uid in resource.data.adminIds;
      
      // Group messages subcollection
      match /messages/{messageId} {
        allow read: if signedIn();
        allow create: if signedIn();
        allow update: if signedIn();
        allow delete: if signedIn();
      }
    }
    
    // Live streams
    match /livestreams/{streamId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn() && (request.auth.uid == resource.data.hostId || isAdmin());
      allow delete: if signedIn() && (request.auth.uid == resource.data.hostId || isAdmin());
      
      // Chat messages subcollection
      match /messages/{messageId} {
        allow read: if signedIn();
        allow create: if signedIn();
        allow update: if signedIn() && (request.auth.uid == resource.data.senderId || isAdmin());
        allow delete: if isAdmin();
      }
      
      // Reactions subcollection
      match /reactions/{reactionId} {
        allow read: if signedIn();
        allow create: if signedIn();
        allow delete: if isAdmin();
      }
      
      // Viewers subcollection
      match /viewers/{viewerId} {
        allow read: if signedIn();
        allow create: if signedIn();
        allow update: if signedIn();
        allow delete: if signedIn();
      }
    }
  }
}
