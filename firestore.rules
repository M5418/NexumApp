rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {
    // Helper functions
    function signedIn() { 
      return request.auth != null; 
    }
    
    function isOwner(uid) { 
      return signedIn() && request.auth.uid == uid; 
    }
    
    function hasRole(role) {
      return signedIn() && request.auth.token[role] == true;
    }
    
    function isAdmin() {
      return hasRole('admin');
    }
    
    // User profiles
    match /users/{uid} {
      allow read: if true;                       // Public profiles
      allow create: if isOwner(uid);             // User creates own profile
      allow update: if isOwner(uid) || isAdmin(); // User or admin can update
      allow delete: if isOwner(uid) || isAdmin(); // User or admin can delete
      
      // User notifications subcollection
      match /notifications/{notifId} {
        allow read: if isOwner(uid);
        allow create: if signedIn();             // Usually via Functions
        allow update: if isOwner(uid);
        allow delete: if isOwner(uid);
      }
    }
    
    // Posts
    match /posts/{postId} {
      allow read: if true;                       // Public posts
      allow create: if signedIn();               // Authenticated users can post
      allow update: if signedIn() && 
        (request.auth.uid == resource.data.authorId || isAdmin());
      allow delete: if signedIn() && 
        (request.auth.uid == resource.data.authorId || isAdmin());
      
      // Post likes subcollection
      match /likes/{likeId} {
        allow read: if true;
        allow create: if signedIn();
        allow delete: if signedIn();
      }
      
      // Post bookmarks subcollection
      match /bookmarks/{bookmarkId} {
        allow read: if signedIn();
        allow create: if signedIn();
        allow delete: if signedIn();
      }
    }
    
    // Comments
    match /comments/{commentId} {
      allow read: if true;                       // Public comments
      allow create: if signedIn();
      allow update: if signedIn() && 
        (request.auth.uid == resource.data.authorId || isAdmin());
      allow delete: if signedIn() && 
        (request.auth.uid == resource.data.authorId || isAdmin());
      
      // Comment likes subcollection
      match /likes/{likeId} {
        allow read: if true;
        allow create: if signedIn();
        allow delete: if signedIn();
      }
    }
    
    // Follows
    match /follows/{id} {
      allow read: if true;                       // Public follow relationships
      allow create: if signedIn();
      allow delete: if signedIn();
      allow update: if signedIn();
    }
    
    // Invitations
    match /invitations/{invitationId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if signedIn();
    }
    
    // Conversations
    match /conversations/{conversationId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if signedIn();
      
      // Conversation messages subcollection
      match /messages/{msgId} {
        allow read: if signedIn();
        allow create: if signedIn();
        allow update: if signedIn();
        allow delete: if signedIn();
      }
    }
    
    // Communities
    match /communities/{communityId} {
      allow read: if true;                       // Public communities
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if isAdmin();
      
      // Community members subcollection
      match /members/{memberId} {
        allow read: if true;
        allow create: if signedIn();
        allow update: if signedIn();
        allow delete: if signedIn();
      }
    }
    
    // CollectionGroup query support for community members  
    // Must match or be more permissive than subcollection rule
    match /{path=**}/members/{memberId} {
      allow read: if true;                       // Public read to match subcollection rule
    }
    
    // Stories
    match /stories/{storyId} {
      allow read: if true;
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if signedIn();
    }
    
    // Story rings
    match /story_rings/{ringId} {
      allow read: if true;
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if signedIn();
    }
    
    // Books
    match /books/{bookId} {
      allow read: if true;
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if isAdmin();
    }
    
    // Book categories
    match /book_categories/{categoryId} {
      allow read: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Book progress
    match /book_progress/{progressId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if signedIn();
    }
    
    // Podcasts
    match /podcasts/{podcastId} {
      allow read: if true;
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if isAdmin();
    }
    
    // Podcast categories
    match /podcast_categories/{categoryId} {
      allow read: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Podcast progress
    match /podcast_progress/{progressId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if signedIn();
    }
    
    // Mentors
    match /mentors/{mentorId} {
      allow read: if true;
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if signedIn();
    }
    
    // Mentorship conversations
    match /mentorship_conversations/{conversationId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if signedIn();
    }
    
    // Mentorship fields
    match /mentorship_fields/{fieldId} {
      allow read: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Mentorship requests
    match /mentorship_requests/{requestId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if signedIn();
    }
    
    // Reports
    match /reports/{reportId} {
      allow read: if isAdmin();
      allow create: if signedIn();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // KYC requests
    match /kyc_requests/{kycId} {
      allow read: if signedIn() && (isOwner(resource.data.userId) || isAdmin());
      allow create: if signedIn();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
  }
}
